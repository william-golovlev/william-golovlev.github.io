<!DOCTYPE html>
<html lang="en">
  Â 
  <head>
    Â  Â  Â  Â  Â  Â 
    <meta charset="UTF-8" />
    Â  Â  Â  Â  Â  Â 
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    Â  Â  Â  Â  Â  Â 
    <title>SQL CTE - Power up your queries!</title>
    Â  Â  Â  Â  Â  Â 
    <link rel="icon" type="image/png" href="/assets/will.png" />
    Â  Â  Â  Â  Â  Â 
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css"
    />
    Â  Â 
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    Â  Â 
    <link rel="stylesheet" href="/assets/styles.css" />
    Â 
  </head>
  Â 
  <body>
    Â  Â  Â  Â 
    <video autoplay muted loop playsinline id="video-background"></video> Â  Â  Â 
    Â  Â  Â  <header>
  <nav class="custom-header">
    <div class="header-content">
      <a class="logo-link" href="/">
        <figure class="image is-32x32">
          <img
            class="is-rounded-will"
            src="/assets/will.png"
            alt="William's Blog"
          />
        </figure>
      </a>

      <div class="header-right">
        <div class="nav-links">
          <a href="/about.html">
            <span class="icon"><i class="fas fa-info-circle"></i></span>
            <span>About</span>
          </a>
          <a href="/blog.html">
            <span class="icon"><i class="fas fa-blog"></i></span>
            <span>Blog</span>
          </a>
          <a href="/contact.html">
            <span class="icon"><i class="fas fa-envelope"></i></span>
            <span>Contact</span>
          </a>
        </div>

        <a
          role="button"
          class="navbar-burger"
          aria-label="menu"
          aria-expanded="false"
          data-target="navMenu"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>

        <div id="navMenu" class="navbar-menu"></div>
      </div>
    </div>
  </nav>
</header>
 Â  Â  Â  Â 
    <main class="content-container">Â  Â  Â  <div class="content-container">
  <div class="paper-container">
    <nav class="level is-mobile post-nav-links">
      <div class="level-left">
        
        <a href="/2025/09/09/sql-window.html" class="button post-nav-button">
          <span class="icon is-small"><i class="fas fa-arrow-left"></i></span>
          <span>Prev Post</span>
        </a>
        
      </div>
      <div class="level-right">
        
        <a href="/2025/09/13/mcp.html" class="button post-nav-button">
          <span>Next Post</span>
          <span class="icon is-small"><i class="fas fa-arrow-right"></i></span>
        </a>
        
      </div>
    </nav>

    <h1 class="title is-2 post-title">SQL CTE - Power up your queries!</h1>

    <div class="post-meta">
      <p>Written by William Golovlev on September 09, 2025</p>
    </div>

    
    <figure class="image post-figure">
      <img src="/assets/blog-images/8.png" alt="SQL CTE - Power up your queries!" />
    </figure>

    <div class="content post-content"><p>As your SQL queries grow in complexity, they can become a messy tangle of subqueries and nested logic. This is where Common Table Expressions (CTEs) come in. Think of a CTE as a temporary, named result set that you can reference within a SELECT, INSERT, UPDATE, or DELETE statement.</p>

<p>While you might be used to using subqueries, CTEs are a huge step up because they make your code far more readable, organized, and reusable.</p>

<h3 id="1-the-basics-introducing-the-with-clause">1. The Basics: Introducing the WITH Clause</h3>

<p>A CTE is defined using the WITH clause, which comes at the beginning of your query. You give the CTE a name, define its contents, and then write your main query as if the CTE were a regular table.</p>

<p>Basic Syntax:
SQL</p>

<p>WITH your_cte_name AS (
SELECT column1, column2, â€¦
FROM your_table
WHERE condition
)
SELECT *
FROM your_cte_name;</p>

<p>Example:
Imagine we want to find the top 10% of customers by sales. Without a CTE, this can get complicated. With a CTE, we can first identify the total sales for each customer and then query that result.
SQL</p>

<p>WITH customer_sales AS (
SELECT
customer_id,
SUM(sales_amount) AS total_sales
FROM
sales
GROUP BY
customer_id
)
SELECT
customer_id,
total_sales
FROM
customer_sales
ORDER BY
total_sales DESC
LIMIT 10;</p>

<p>This is much cleaner than nesting a GROUP BY subquery directly into the FROM clause.</p>

<h3 id="2-intermediate-use-chaining-ctes">2. Intermediate Use: Chaining CTEs</h3>

<p>A single WITH clause can contain multiple CTEs, allowing you to break down a complex problem into a series of logical steps. This is where the power of CTEs really shines. Each subsequent CTE can reference any CTE defined before it in the same WITH clause.</p>

<p>Example: A Multi-Step Query
Letâ€™s find the average sales for a region, then find the products that sold above that average.
SQL</p>

<p>WITH
regional_sales AS (
SELECT
region,
AVG(amount) AS avg_regional_sales
FROM
sales
GROUP BY
region
),
product_performance AS (
SELECT
product,
region,
SUM(amount) AS total_sales
FROM
sales
GROUP BY
product,
region
)
SELECT
p.product,
p.total_sales,
r.avg_regional_sales
FROM
product_performance p
JOIN
regional_sales r ON p.region = r.region
WHERE
p.total_sales &gt; r.avg_regional_sales;</p>

<p>This multi-CTE approach makes the logic transparent and easy to follow, as each step is clearly defined.</p>

<h3 id="3-advanced-topic-recursive-ctes-">3. Advanced Topic: Recursive CTEs ðŸ”„</h3>

<p>This is the most powerful and complex use of a CTE. A recursive CTE is a query that references itself. Itâ€™s designed to handle hierarchical or graph-like data, such as organizational charts, bill-of-materials, or social network connections.</p>

<p>A recursive CTE has two parts, connected by a UNION ALL:</p>

<p>The Anchor Member: The base query that provides the initial row(s) for the recursion. This part is not recursive.</p>

<p>The Recursive Member: The query that references the CTE itself to generate the next row(s). It continues to execute as long as new rows are being returned.</p>

<p>Example: An Organizational Chart
Letâ€™s say we have an employees table with employee_id and manager_id. We want to find the full management chain for a specific employee.
SQL</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">org_chart</span> <span class="k">AS</span> <span class="p">(</span>
<span class="c1">-- Anchor Member: Find the starting employee</span>
<span class="k">SELECT</span>
<span class="n">employee_id</span><span class="p">,</span>
<span class="n">manager_id</span><span class="p">,</span>
<span class="n">employee_name</span><span class="p">,</span>
<span class="mi">1</span> <span class="k">AS</span> <span class="k">level</span>
<span class="k">FROM</span>
<span class="n">employees</span>
<span class="k">WHERE</span>
<span class="n">employee_name</span> <span class="o">=</span> <span class="s1">'Alice'</span>

    <span class="k">UNION</span> <span class="k">ALL</span>

    <span class="c1">-- Recursive Member: Find the manager of the previous result</span>
    <span class="k">SELECT</span>
        <span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span>
        <span class="n">e</span><span class="p">.</span><span class="n">manager_id</span><span class="p">,</span>
        <span class="n">e</span><span class="p">.</span><span class="n">employee_name</span><span class="p">,</span>
        <span class="n">o</span><span class="p">.</span><span class="k">level</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">AS</span> <span class="k">level</span>
    <span class="k">FROM</span>
        <span class="n">employees</span> <span class="n">e</span>
    <span class="k">JOIN</span>
        <span class="n">org_chart</span> <span class="n">o</span> <span class="k">ON</span> <span class="n">e</span><span class="p">.</span><span class="n">employee_id</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">manager_id</span>

<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">org_chart</span><span class="p">;</span>
</code></pre></div></div>

<p>This query starts with â€˜Aliceâ€™ and then recursively finds her manager, then her managerâ€™s manager, and so on, until it hits the top of the chain (where manager_id is NULL).</p>

<h3 id="conclusion">Conclusion</h3>

<p>Mastering CTEs is a crucial step in writing professional, maintainable SQL. They offer a powerful way to simplify complex queries, improve readability, and enable advanced techniques like recursion. By getting comfortable with the WITH clause, youâ€™ll be able to break down any analytical problem into a series of logical, easy-to-understand steps.</p>

<p>Ready to start? Try writing a query to find the average sales for each product category using a CTE. Then, try to find the top-selling product within each category in a single query using multiple CTEs.</p>
</div>
  </div>
</div>
 Â  Â </main>
    Â  Â  Â  Â  Â  Â  Â  Â 
    <script src="/assets/script.js"></script>
    Â 
  </body>
</html>
