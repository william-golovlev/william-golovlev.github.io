---
layout: post
title: SQL CTE - Power up your queries!
date: 2025-09-09 11:00:00 -0800
description: SQL Common Table Expressions (CTEs) - Your Guide to Cleaner, More Powerful Queries
image: /assets/blog-images/6.png
---

As your SQL queries grow in complexity, they can become a messy tangle of subqueries and nested logic. This is where Common Table Expressions (CTEs) come in. Think of a CTE as a temporary, named result set that you can reference within a SELECT, INSERT, UPDATE, or DELETE statement.

While you might be used to using subqueries, CTEs are a huge step up because they make your code far more readable, organized, and reusable.

1. The Basics: Introducing the WITH Clause

A CTE is defined using the WITH clause, which comes at the beginning of your query. You give the CTE a name, define its contents, and then write your main query as if the CTE were a regular table.

Basic Syntax:
SQL

WITH your_cte_name AS (
SELECT column1, column2, ...
FROM your_table
WHERE condition
)
SELECT \*
FROM your_cte_name;

Example:
Imagine we want to find the top 10% of customers by sales. Without a CTE, this can get complicated. With a CTE, we can first identify the total sales for each customer and then query that result.
SQL

WITH customer_sales AS (
SELECT
customer_id,
SUM(sales_amount) AS total_sales
FROM
sales
GROUP BY
customer_id
)
SELECT
customer_id,
total_sales
FROM
customer_sales
ORDER BY
total_sales DESC
LIMIT 10;

This is much cleaner than nesting a GROUP BY subquery directly into the FROM clause.

2. Intermediate Use: Chaining CTEs

A single WITH clause can contain multiple CTEs, allowing you to break down a complex problem into a series of logical steps. This is where the power of CTEs really shines. Each subsequent CTE can reference any CTE defined before it in the same WITH clause.

Example: A Multi-Step Query
Let's find the average sales for a region, then find the products that sold above that average.
SQL

WITH
regional_sales AS (
SELECT
region,
AVG(amount) AS avg_regional_sales
FROM
sales
GROUP BY
region
),
product_performance AS (
SELECT
product,
region,
SUM(amount) AS total_sales
FROM
sales
GROUP BY
product,
region
)
SELECT
p.product,
p.total_sales,
r.avg_regional_sales
FROM
product_performance p
JOIN
regional_sales r ON p.region = r.region
WHERE
p.total_sales > r.avg_regional_sales;

This multi-CTE approach makes the logic transparent and easy to follow, as each step is clearly defined.

3. Advanced Topic: Recursive CTEs ðŸ”„

This is the most powerful and complex use of a CTE. A recursive CTE is a query that references itself. It's designed to handle hierarchical or graph-like data, such as organizational charts, bill-of-materials, or social network connections.

A recursive CTE has two parts, connected by a UNION ALL:

    The Anchor Member: The base query that provides the initial row(s) for the recursion. This part is not recursive.

    The Recursive Member: The query that references the CTE itself to generate the next row(s). It continues to execute as long as new rows are being returned.

Example: An Organizational Chart
Let's say we have an employees table with employee_id and manager_id. We want to find the full management chain for a specific employee.
SQL

WITH RECURSIVE org_chart AS (
-- Anchor Member: Find the starting employee
SELECT
employee_id,
manager_id,
employee_name,
1 AS level
FROM
employees
WHERE
employee_name = 'Alice'

    UNION ALL

    -- Recursive Member: Find the manager of the previous result
    SELECT
        e.employee_id,
        e.manager_id,
        e.employee_name,
        o.level + 1 AS level
    FROM
        employees e
    JOIN
        org_chart o ON e.employee_id = o.manager_id

)
SELECT \* FROM org_chart;

This query starts with 'Alice' and then recursively finds her manager, then her manager's manager, and so on, until it hits the top of the chain (where manager_id is NULL).

Conclusion

Mastering CTEs is a crucial step in writing professional, maintainable SQL. They offer a powerful way to simplify complex queries, improve readability, and enable advanced techniques like recursion. By getting comfortable with the WITH clause, you'll be able to break down any analytical problem into a series of logical, easy-to-understand steps.

Ready to start? Try writing a query to find the average sales for each product category using a CTE. Then, try to find the top-selling product within each category in a single query using multiple CTEs.
